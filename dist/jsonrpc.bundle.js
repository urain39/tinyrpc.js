!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TINYRPC={})}(this,function(e){"use strict";var h=void 0,n={}.hasOwnProperty,t=(a.prototype.onOpen=function(e){return this._ws.addEventListener("open",e),this._listeners.open.push(e),this},a.prototype.onError=function(e){return this._ws.addEventListener("error",e),this._listeners.error.push(e),this},a.prototype.onClose=function(e){return this._ws.addEventListener("close",e),this._listeners.close.push(e),this},a.prototype.onNotify=function(e,t){return this._notifiers[e]=t,this},a.prototype.request=function(e,t,s,r){return void 0===r&&(r=!1),this._request(e,t,s,r),this},a.prototype._request=function(e,t,s,r,i){if(!r&&this.requestCount>=a.MAX_REQUEST_COUNT&&!i)s(h,{code:a.ERROR_MAX_CONCURRENT,message:"Max concurrent error"});else{i===h&&(i=this._requestId++,r||this.requestCount++);var n=this._requests;if(this.isReady){for(;0<n.length;)this._request.apply(this,n.shift());var o={jsonrpc:"2.0",id:i,method:e,params:t};this._ws.send(JSON.stringify(o)),this._handlers[i]=s}else n.push([e,t,s,r,i])}},a.prototype.close=function(){for(var e,t=[],s=0;s<arguments.length;s++)t[s]=arguments[s];(e=this._ws).close.apply(e,t)},a.prototype.reconnect=function(){for(var e=this._listeners,t=new WebSocket(this.rpcPath),s=0,r=e.open;s<r.length;s++){var i=r[s];t.addEventListener("open",i)}for(var n=0,o=e.error;n<o.length;n++){i=o[n];t.addEventListener("error",i)}for(var h=0,a=e.message;h<a.length;h++){i=a[h];t.addEventListener("message",i)}for(var l=0,p=e.close;l<p.length;l++){i=p[l];t.addEventListener("close",i)}return this._ws=t,this},a.MAX_REQUEST_COUNT=8,a.ERROR_MAX_CONCURRENT=-32032,a);function a(e,t){this.rpcPath=e,this.preprocess=t,this.isReady=!1,this.requestCount=0,this._ws=new WebSocket(this.rpcPath),this._requestId=0,this._requests=[],this._listeners={open:[],error:[],message:[],close:[]},this._handlers={},this._notifiers={};var i=this;this.onOpen(function(){i.isReady=!0}),this.onClose(function(){i.isReady=!1}),this._ws.addEventListener("message",t=function(e){var t=JSON.parse(e.data),e=i.preprocess;if(e&&(t=e(t)),n.call(t,"id")){var s=t.id,r=i._handlers;if(n.call(r,s)){e=r[s];if(n.call(t,"result"))e(t.result,h);else{if(!n.call(t,"error"))throw new Error("Invalid response with no `result` or `error`");e(h,t.error)}delete r[s],i.requestCount--}}else{if(!n.call(t,"method"))throw new Error("Invalid response with no `id` or `method`");r=t.method,s=i._notifiers;n.call(s,r)&&(r=s[r],(t=t.params)&&r(t))}}),this._listeners.message.push(t)}e.JSONRPC=t,Object.defineProperty(e,"__esModule",{value:!0})});
