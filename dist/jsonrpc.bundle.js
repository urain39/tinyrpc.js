!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TINYRPC={})}(this,function(e){"use strict";var a=void 0,n={}.hasOwnProperty,t=(u.prototype.onOpen=function(e){return this._ws.addEventListener("open",e),this},u.prototype.onError=function(e){return this._ws.addEventListener("error",e),this},u.prototype.onClose=function(e){return this._ws.addEventListener("close",e),this},u.prototype.onNotify=function(e,t){return this._notifiers[e]=t,this},u.prototype.request=function(e,t,r,s){return void 0===s&&(s=!1),this._request(e,t,r,s),this},u.prototype._request=function(e,t,r,s,o){var n,i;!s&&this.requestCount>=u.MAX_REQUEST_COUNT&&!o?r(a,{code:u.ERROR_MAX_CONCURRENT,message:"Max concurrent error"}):(o===a&&(o=this._requestId++,s||this.requestCount++),this.isReady?(n={jsonrpc:"2.0",id:o,method:e,params:t},this._ws.send(JSON.stringify(n)),this._handlers[o]=r):(i=this,setTimeout(function(){i._request(e,t,r,s,o)},u.CONNECTION_CHECK_DELAY)))},u.prototype.heartbeat=function(e,t,r){var s=!1,o=this,n=setInterval(function(){s&&(o.close(),clearInterval(n),r(s,a,{code:u.ERROR_HEARTBEAT_TIMEDOUT,message:"Heartbeat timed out"})),s=!0,o.request(e,t,function(e,t){r(s=!1,e,t)},!0)},u.HEARTBEAT_DELAY);return this},u.prototype.close=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return(e=this._ws).close.apply(e,t)},u.MAX_REQUEST_COUNT=8,u.CONNECTION_CHECK_DELAY=1e3,u.HEARTBEAT_DELAY=15e3,u.ERROR_MAX_CONCURRENT=-32032,u.ERROR_HEARTBEAT_TIMEDOUT=-32033,u);function u(e){this.rpcPath=e,this.isReady=!1,this.requestCount=0,this._ws=new WebSocket(this.rpcPath),this._requestId=0,this._handlers={},this._notifiers={};var o=this;this.onOpen(function(){o.isReady=!0}),this.onClose(function(){o.isReady=!1}),this._ws.addEventListener("message",function(e){var t=JSON.parse(e.data);if(n.call(t,"id")){var r=t.id,s=o._handlers;if(n.call(s,r)){e=s[r];if(n.call(t,"result"))e(t.result,a);else{if(!n.call(t,"error"))throw new Error("Invalid response with no `result` or `error`");e(a,t.error)}s[r]=a,o.requestCount--}}else{if(!n.call(t,"method"))throw new Error("Invalid response with no `id` or `method`");s=t.method,r=o._notifiers;n.call(r,s)&&(s=r[s],(t=t.params)&&s(t))}})}e.JSONRPC=t,Object.defineProperty(e,"__esModule",{value:!0})});
