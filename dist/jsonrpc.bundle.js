!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TINYRPC={})}(this,function(e){"use strict";var a=void 0,o={}.hasOwnProperty,t=(u.prototype.onOpen=function(e){return this._ws.addEventListener("open",e),this._listeners.open.push(e),this},u.prototype.onError=function(e){return this._ws.addEventListener("error",e),this._listeners.error.push(e),this},u.prototype.onClose=function(e){return this._ws.addEventListener("close",e),this._listeners.close.push(e),this},u.prototype.onNotify=function(e,t){return this._notifiers[e]=t,this},u.prototype.request=function(e,t,s,r){return void 0===r&&(r=!1),this._request(e,t,s,r),this},u.prototype._request=function(e,t,s,r,n){var o,i;!r&&this.requestCount>=u.MAX_REQUEST_COUNT&&!n?s(a,{code:u.ERROR_MAX_CONCURRENT,message:"Max concurrent error"}):(n===a&&(n=this._requestId++,r||this.requestCount++),this.isReady?(o={jsonrpc:"2.0",id:n,method:e,params:t},this._ws.send(JSON.stringify(o)),this._handlers[n]=s):(i=this,setTimeout(function(){i._request(e,t,s,r,n)},u.CONNECTION_CHECK_DELAY)))},u.prototype.heartbeat=function(e,t,s,r){void 0===r&&(r=3);var n=!1,o=0,i=this,h=setInterval(function(){n&&(r<=o&&(i.close(),s(n,a,{code:u.ERROR_HEARTBEAT_TIMEDOUT,message:"Heartbeat timed out"}),clearInterval(h)),o++),n=!0,i.request(e,t,function(e,t){o=0,s(n=!1,e,t)},!0)},u.HEARTBEAT_DELAY);return this},u.prototype.close=function(){for(var e,t=[],s=0;s<arguments.length;s++)t[s]=arguments[s];(e=this._ws).close.apply(e,t)},u.prototype.reconnect=function(){for(var e=this._listeners,t=new WebSocket(this.rpcPath),s=0,r=e.open;s<r.length;s++){var n=r[s];t.addEventListener("open",n)}for(var o=0,i=e.error;o<i.length;o++){n=i[o];t.addEventListener("error",n)}for(var h=0,a=e.message;h<a.length;h++){n=a[h];t.addEventListener("message",n)}for(var u=0,l=e.close;u<l.length;u++){n=l[u];t.addEventListener("close",n)}return this._ws=t,this},u.MAX_REQUEST_COUNT=8,u.CONNECTION_CHECK_DELAY=1e3,u.HEARTBEAT_DELAY=15e3,u.ERROR_MAX_CONCURRENT=-32032,u.ERROR_HEARTBEAT_TIMEDOUT=-32033,u);function u(e,t){this.rpcPath=e,this.preprocess=t,this.isReady=!1,this.requestCount=0,this._ws=new WebSocket(this.rpcPath),this._requestId=0,this._listeners={open:[],error:[],message:[],close:[]},this._handlers={},this._notifiers={};var n=this;this.onOpen(function(){n.isReady=!0}),this.onClose(function(){n.isReady=!1}),this._ws.addEventListener("message",t=function(e){var t=JSON.parse(e.data),e=n.preprocess;if(e&&(t=e(t)),o.call(t,"id")){var s=t.id,r=n._handlers;if(o.call(r,s)){e=r[s];if(o.call(t,"result"))e(t.result,a);else{if(!o.call(t,"error"))throw new Error("Invalid response with no `result` or `error`");e(a,t.error)}r[s]=a,n.requestCount--}}else{if(!o.call(t,"method"))throw new Error("Invalid response with no `id` or `method`");r=t.method,s=n._notifiers;o.call(s,r)&&(r=s[r],(t=t.params)&&r(t))}}),this._listeners.message.push(t)}e.JSONRPC=t,Object.defineProperty(e,"__esModule",{value:!0})});
