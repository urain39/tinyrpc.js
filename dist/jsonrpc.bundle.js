!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TINYRPC={})}(this,function(e){"use strict";var h=void 0,o={}.hasOwnProperty,t=(a.prototype.onOpen=function(e){return this._ws.addEventListener("open",e),this._listeners.open.push(e),this},a.prototype.onError=function(e){return this._ws.addEventListener("error",e),this._listeners.error.push(e),this},a.prototype.onClose=function(e){return this._ws.addEventListener("close",e),this._listeners.close.push(e),this},a.prototype.onNotify=function(e,t){return this._notifiers[e]=t,this},a.prototype.request=function(e,t,s,r){return void 0===r&&(r=!1),this._request(e,t,s,r),this},a.prototype._request=function(e,t,s,r,n){var o,i;!r&&this.requestCount>=a.MAX_REQUEST_COUNT&&!n?s(h,{code:a.ERROR_MAX_CONCURRENT,message:"Max concurrent error"}):(n===h&&(n=this._requestId++,r||this.requestCount++),this.isReady?(o={jsonrpc:"2.0",id:n,method:e,params:t},this._ws.send(JSON.stringify(o)),this._handlers[n]=s):(i=this,setTimeout(function(){i._request(e,t,s,r,n)},a.CONNECTION_CHECK_DELAY)))},a.prototype.close=function(){for(var e,t=[],s=0;s<arguments.length;s++)t[s]=arguments[s];(e=this._ws).close.apply(e,t)},a.prototype.reconnect=function(){for(var e=this._listeners,t=new WebSocket(this.rpcPath),s=0,r=e.open;s<r.length;s++){var n=r[s];t.addEventListener("open",n)}for(var o=0,i=e.error;o<i.length;o++){n=i[o];t.addEventListener("error",n)}for(var h=0,a=e.message;h<a.length;h++){n=a[h];t.addEventListener("message",n)}for(var d=0,l=e.close;d<l.length;d++){n=l[d];t.addEventListener("close",n)}return this._ws=t,this},a.MAX_REQUEST_COUNT=8,a.CONNECTION_CHECK_DELAY=1e3,a.ERROR_MAX_CONCURRENT=-32032,a);function a(e,t){this.rpcPath=e,this.preprocess=t,this.isReady=!1,this.requestCount=0,this._ws=new WebSocket(this.rpcPath),this._requestId=0,this._listeners={open:[],error:[],message:[],close:[]},this._handlers={},this._notifiers={};var n=this;this.onOpen(function(){n.isReady=!0}),this.onClose(function(){n.isReady=!1}),this._ws.addEventListener("message",t=function(e){var t=JSON.parse(e.data),e=n.preprocess;if(e&&(t=e(t)),o.call(t,"id")){var s=t.id,r=n._handlers;if(o.call(r,s)){e=r[s];if(o.call(t,"result"))e(t.result,h);else{if(!o.call(t,"error"))throw new Error("Invalid response with no `result` or `error`");e(h,t.error)}r[s]=h,n.requestCount--}}else{if(!o.call(t,"method"))throw new Error("Invalid response with no `id` or `method`");r=t.method,s=n._notifiers;if(!o.call(s,r))throw new Error("Invalid notification with unknown `method`");r=s[r],t=t.params;t&&r(t)}}),this._listeners.message.push(t)}e.JSONRPC=t,Object.defineProperty(e,"__esModule",{value:!0})});
